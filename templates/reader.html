{% extends "base.html" %}

{% block title %}NovelVoice - ç« èŠ‚é˜…è¯»{% endblock %}

{% block extra_styles %}
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: #f9f6f0; /* æ•´ä¸ªé¡µé¢ä½¿ç”¨é˜…è¯»èƒŒæ™¯è‰² */
            min-height: 100vh;
            padding: 0;
        }
        
        .container {
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            padding: 20px;
            max-width: 100%;
            margin: 0;
            min-height: 100vh;
            padding-top: 60px;
            padding-bottom: 80px;
        }

        /* é¡¶éƒ¨æ‚¬æµ®é¢æ¿ */
        .top-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(249, 246, 240, 0.98) 0%, rgba(249, 246, 240, 0.9) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 3000;
            transform: translateY(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .top-panel.visible {
            transform: translateY(0);
        }
        
        /* åº•éƒ¨æ‚¬æµ®é¢æ¿ */
        .bottom-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(0deg, rgba(249, 246, 240, 0.98) 0%, rgba(249, 246, 240, 0.9) 100%);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            z-index: 10000;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .bottom-panel.visible {
            transform: translateY(0);
        }
        
        /* é¢æ¿æŒ‰é’®æ ·å¼ */
        .panel-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            min-width: 60px;
        }
        
        .panel-btn i {
            font-size: 20px;
        }
        
        .panel-btn span {
            font-size: 12px;
        }
        
        .panel-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .panel-btn:active {
            transform: scale(0.95);
        }
        
        .panel-btn.disabled {
            color: #ccc;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* é¡¶éƒ¨é¢æ¿æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        .top-panel .panel-btn {
            flex-direction: row;
            gap: 8px;
            min-width: auto;
        }
        
        .top-panel .panel-btn i {
            font-size: 22px;
        }
        
        .top-panel .panel-btn span {
            font-size: 14px;
        }
        
        .header {
            display: none;
        }
        
        .chapter-title {
            text-align: center;
            font-size: 28px;
            margin: 30px 0;
            color: #333;
            font-weight: bold;
        }
        
        .chapter-content {
            font-family: "SimSun", "å®‹ä½“", serif;
            font-size: 18px;
            color: #444;
            white-space: pre-wrap;
            text-align: justify;
            line-height: 1.8;
            margin-bottom: 30px;
            transition: font-size 0.3s ease;
            /* cursor: pointer; */ /* æ·»åŠ æ‰‹å‹æŒ‡é’ˆï¼Œæç¤ºå¯ç‚¹å‡» */
        }
        
        .chapter-content p {
            margin-bottom: 20px;
            text-indent: 2em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }
        
        /* ç« èŠ‚é€‰æ‹©é¢æ¿ */
        .chapter-panel {
            position: fixed;
            right: -320px;
            top: 0;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 15px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        
        .chapter-panel.open {
            right: 0;
        }
        
        .chapter-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .chapter-panel-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .chapter-panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .chapter-panel-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chapter-panel-search {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .chapter-panel-search input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .chapter-panel-search input:focus {
            border-color: #667eea;
        }
        
        .chapter-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .chapter-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .chapter-item:hover {
            background: #f8f8f8;
        }
        
        .chapter-item.active {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
        }
        
        .chapter-item-title {
            font-size: 15px;
            color: #333;
            line-height: 1.5;
        }
        
        .chapter-item.active .chapter-item-title {
            color: #667eea;
            font-weight: 500;
        }
        
        .chapter-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .chapter-panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: row;
                justify-content: space-between;
                gap: 10px;
            }
            
            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .nav-links {
                flex-direction: row;
                gap: 8px;
            }
            
            #novelTitle {
                width: 100%;
                text-align: center;
                order: -1;
            }
            
            .chapter-title {
                font-size: 22px;
            }
            
            .chapter-content {
                font-size: 17px;
                line-height: 1.8;
            }
            
            .nav-button {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .font-size-control {
                right: 10px;
                bottom: 90px;
            }
            
            .chapter-panel {
                width: 75%;
                right: -75%;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
    <div class="chapter-title" id="chapterTitle">åŠ è½½ä¸­...</div>
    
    <div class="chapter-content" id="chapterContent">
        <div class="loading">æ­£åœ¨åŠ è½½ç« èŠ‚å†…å®¹...</div>
    </div>
    </div>
    
    <!-- é¡¶éƒ¨æ‚¬æµ®é¢æ¿ -->
    <div class="top-panel" id="topPanel">
        <button class="panel-btn" id="backBtn" title="è¿”å›å°è¯´åˆ—è¡¨">
            <i class="fas fa-arrow-left"></i>
        </button>
        <button class="panel-btn" id="audiobookBtn" title="æœ‰å£°ä¹¦">
            <i class="fas fa-headphones"></i>
        </button>
    </div>
    
    <!-- åº•éƒ¨æ‚¬æµ®é¢æ¿ -->
    <div class="bottom-panel" id="bottomPanel">
        <button class="panel-btn" id="prevChapterBtn" title="ä¸Šä¸€ç« ">
            <i class="fas fa-chevron-left"></i>
            <span>ä¸Šä¸€ç« </span>
        </button>
        <button class="panel-btn" id="tocBtn" title="ç« èŠ‚ç›®å½•">
            <i class="fas fa-list"></i>
            <span>ç›®å½•</span>
        </button>
        <button class="panel-btn" id="fontDecreaseBtn" title="å‡å°å­—ä½“">
            <i class="fas fa-font"></i>
            <span>A-</span>
        </button>
        <button class="panel-btn" id="fontIncreaseBtn" title="å¢å¤§å­—ä½“">
            <i class="fas fa-font"></i>
            <span>A+</span>
        </button>
        <button class="panel-btn" id="nextChapterBtn" title="ä¸‹ä¸€ç« ">
            <span>ä¸‹ä¸€ç« </span>
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    
    <!-- ç« èŠ‚é€‰æ‹©é¢æ¿ -->
    <div class="chapter-panel" id="chapterPanel">
        <div class="chapter-panel-header">
            <span class="chapter-panel-title">ç« èŠ‚ç›®å½•</span>
            <button class="chapter-panel-close" id="closeChapterPanel">&times;</button>
        </div>
        <div class="chapter-panel-search">
            <input type="text" id="chapterSearch" placeholder="æœç´¢ç« èŠ‚..." />
        </div>
        <div class="chapter-panel-content" id="chapterList">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- ç« èŠ‚é€‰æ‹©é¢æ¿é®ç½© -->
    <div class="chapter-panel-overlay" id="chapterPanelOverlay"></div>
{% endblock %}

{% block extra_scripts %}
<script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const novelId = urlParams.get('novel_id');
        const chapterId = urlParams.get('chapter_id');
        
        // Debug: Log parameters
        console.log('novelId:', novelId, 'type:', typeof novelId);
        console.log('chapterId:', chapterId, 'type:', typeof chapterId);
        
        // Global variables to store novel and chapter data
        let novelData = null;
        let chaptersData = [];
        let currentChapterIndex = -1;
        
        // Fetch novel information
        fetch(`/novels`)
            .then(response => response.json())
            .then(data => {
                novelData = data.novels.find(novel => novel.id == novelId);
                if (novelData) {
                    document.getElementById('novelTitle').textContent = novelData.title;
                }
            });
        
        // Fetch chapters for this novel
        fetch(`/chapters?novel_id=${novelId}`)
            .then(response => response.json())
            .then(data => {
                chaptersData = data.chapters;
                
                // Find current chapter index
                currentChapterIndex = chaptersData.findIndex(chapter => chapter.id == chapterId);
                
                // Load the chapter content
                loadChapterContent(chapterId);
                
                // Update navigation buttons
                updateNavigation();
            });
        
        // Load chapter content
        function loadChapterContent(chapterId) {
            // Show loading indicator
            document.getElementById('chapterContent').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç« èŠ‚å†…å®¹...</div>';
            
            // Debug: Log parameters being sent
            console.log('Sending request with novelId:', novelId, 'chapterId:', chapterId);
            
            // Fetch chapter content from the novel file
            const url = `/chapters/${chapterId}/content?novel_id=${novelId}`;
            console.log('Request URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.content) {
                        document.getElementById('chapterTitle').textContent = data.title;
                        // å¤„ç†æ®µè½å†…å®¹ï¼šå»æ‰å¼€å¤´çš„å¤šä½™ç©ºæ ¼ï¼Œä¿æŒåˆç†çš„ç¼©è¿›
                        const processedContent = data.content
                            .replace(/\n/g, '</p><p>')
                            .replace(/<p>\s+/g, '<p>') // å»æ‰æ¯ä¸ªæ®µè½å¼€å¤´çš„ç©ºæ ¼
                            .trim();
                        document.getElementById('chapterContent').innerHTML = `<p>${processedContent}</p>`;
                        
                        // æ›´æ–°é˜…è¯»è¿›åº¦
                        updateReadingProgress(novelId, chapterId);
                    } else {
                        document.getElementById('chapterContent').innerHTML = '<p>æ— æ³•åŠ è½½ç« èŠ‚å†…å®¹ã€‚</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading chapter content:', error);
                    document.getElementById('chapterContent').innerHTML = `<p>åŠ è½½ç« èŠ‚å†…å®¹æ—¶å‡ºé”™: ${error.message}</p>`;
                });
        }
        
        // Update navigation buttons
        function updateNavigation() {
            const prevButton = document.getElementById('prevChapterBtn');
            const nextButton = document.getElementById('nextChapterBtn');
            const audiobookBtn = document.getElementById('audiobookBtn');
            
            // Previous chapter
            if (currentChapterIndex > 0) {
                prevButton.classList.remove('disabled');
            } else {
                prevButton.classList.add('disabled');
            }
            
            // Next chapter
            if (currentChapterIndex < chaptersData.length - 1) {
                nextButton.classList.remove('disabled');
            } else {
                nextButton.classList.add('disabled');
            }

            // æ£€æŸ¥å¹¶é¢„å¤„ç†å½“å‰ç« èŠ‚çš„é…éŸ³è„šæœ¬
            initAudiobookPreprocess();
        }
        
        // Switch to previous chapter
        function prevChapter() {
            if (currentChapterIndex > 0) {
                currentChapterIndex--;
                const newChapterId = chaptersData[currentChapterIndex].id;
                switchChapter(newChapterId);
            }
        }
        
        // Switch to next chapter
        function nextChapter() {
            if (currentChapterIndex < chaptersData.length - 1) {
                currentChapterIndex++;
                const newChapterId = chaptersData[currentChapterIndex].id;
                switchChapter(newChapterId);
            }
        }
        
        // Switch to a specific chapter
        function switchChapter(newChapterId) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('chapter_id', newChapterId);
            
            // Update URL without reloading
            const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
            window.history.pushState({ chapterId: newChapterId }, '', newUrl);
            
            // Update global chapterId
            window.currentChapterId = newChapterId;
            
            // Load the new chapter content
            loadChapterContent(newChapterId);
            
            // Update navigation buttons
            updateNavigation();
            
            // Update chapter list active state
            updateChapterListActiveState(newChapterId);
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Open chapter panel
        function openChapterPanel() {
            document.getElementById('chapterPanel').classList.add('open');
            document.getElementById('chapterPanelOverlay').classList.add('open');
            renderChapterList();
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰ç« èŠ‚
            setTimeout(() => {
                const currentChapterId = window.currentChapterId || chapterId;
                const activeChapterItem = document.querySelector(`.chapter-item[data-chapter-id="${currentChapterId}"]`);
                if (activeChapterItem) {
                    activeChapterItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
        // Close chapter panel
        function closeChapterPanel() {
            document.getElementById('chapterPanel').classList.remove('open');
            document.getElementById('chapterPanelOverlay').classList.remove('open');
        }
        
        // Render chapter list
        function renderChapterList(filterText = '') {
            const chapterList = document.getElementById('chapterList');
            
            if (!chaptersData || chaptersData.length === 0) {
                chapterList.innerHTML = '<div class="loading">æš‚æ— ç« èŠ‚</div>';
                return;
            }
            
            let filteredChapters = chaptersData;
            if (filterText) {
                filteredChapters = chaptersData.filter(chapter => 
                    chapter.title.toLowerCase().includes(filterText.toLowerCase())
                );
            }
            
            let html = '';
            filteredChapters.forEach((chapter, index) => {
                const isActive = chapter.id == window.currentChapterId;
                const globalIndex = chaptersData.indexOf(chapter);
                html += `
                    <div class="chapter-item ${isActive ? 'active' : ''}" 
                         data-chapter-id="${chapter.id}"
                         onclick="selectChapter(${chapter.id})">
                        <div class="chapter-item-title">
                            <span style="color: #999; margin-right: 8px;">${globalIndex + 1}.</span>
                            ${chapter.title}
                        </div>
                    </div>
                `;
            });
            
            chapterList.innerHTML = html;
        }
        
        // Select a chapter from the list
        function selectChapter(chapterId) {
            currentChapterIndex = chaptersData.findIndex(chapter => chapter.id == chapterId);
            switchChapter(chapterId);
            closeChapterPanel();
        }
        
        // Update chapter list active state
        function updateChapterListActiveState(chapterId) {
            const items = document.querySelectorAll('.chapter-item');
            items.forEach(item => {
                if (item.dataset.chapterId == chapterId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // Search chapters
        function searchChapters(text) {
            renderChapterList(text);
        }

        let scriptCheckTimer = null;

        function setAudiobookDisabled(disabled, text) {
            const audiobookBtn = document.getElementById('audiobookBtn');
            if (!audiobookBtn) return;
            if (disabled) {
                audiobookBtn.classList.add('disabled');
                if (text) {
                    audiobookBtn.title = text;
                }
            } else {
                audiobookBtn.classList.remove('disabled');
                audiobookBtn.title = 'æœ‰å£°ä¹¦';
            }
        }

        function initAudiobookPreprocess() {
            const currentChapterId = window.currentChapterId;
            if (!currentChapterId) return;

            // åˆå§‹çŠ¶æ€ï¼šå…ˆç½®ç°ï¼Œé¿å…ç”¨æˆ·ç‚¹å‡»
            setAudiobookDisabled(true, 'ğŸµ æœ‰å£°ä¹¦(æ£€æŸ¥ä¸­...)');

            fetch(`/chapters/${currentChapterId}/script-status`)
                .then(response => response.json())
                .then(data => {
                    if (data.ready) {
                        setAudiobookDisabled(false);
                    } else {
                        setAudiobookDisabled(true, 'ğŸµ æœ‰å£°ä¹¦(é¢„å¤„ç†ä¸­...)');

                        fetch(`/chapters/${currentChapterId}/script`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }).catch(error => {
                            console.error('Error starting preprocess:', error);
                        });

                        if (scriptCheckTimer) {
                            clearInterval(scriptCheckTimer);
                        }
                        scriptCheckTimer = setInterval(() => {
                            fetch(`/chapters/${currentChapterId}/script-status`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.ready) {
                                        setAudiobookDisabled(false);
                                        if (scriptCheckTimer) {
                                            clearInterval(scriptCheckTimer);
                                            scriptCheckTimer = null;
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('Error checking script status:', error);
                                });
                        }, 5000);
                    }
                })
                .catch(error => {
                    console.error('Error checking initial script status:', error);
                    // å‡ºé”™æ—¶ï¼Œä¸ºäº†ä¸å½±å“ä½¿ç”¨ï¼Œä»ç„¶å…è®¸ç”¨æˆ·ç‚¹å‡»
                    setAudiobookDisabled(false);
                });
        }
        
        // ä¿®æ”¹æœ‰å£°ä¹¦æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼Œä½¿ç”¨å…¨å±€æ’­æ”¾å™¨
        document.getElementById('audiobookBtn').addEventListener('click', function(e) {
            // å¦‚æœæŒ‰é’®è¢«ç½®ç°ï¼Œåˆ™ä¸å“åº”ç‚¹å‡»
            if (this.classList.contains('disabled')) {
                e.preventDefault();
                return;
            }

            e.preventDefault();
            
            // è°ƒç”¨å…¨å±€æ’­æ”¾å™¨æ’­æ”¾å½“å‰ç« èŠ‚
            if (window.playAudiobook && novelData && window.currentChapterId) {
                const currentChapter = chaptersData.find(ch => ch.id == window.currentChapterId);
                
                console.log(`è¯·æ±‚æ’­æ”¾ç« èŠ‚ ${window.currentChapterId}: ${currentChapter?.title}`);
                
                window.playAudiobook(
                    novelId,
                    novelData.title,
                    window.currentChapterId,
                    currentChapter?.title || 'æœªçŸ¥ç« èŠ‚',
                    chaptersData
                );
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨æ’­æ”¾çš„ç« èŠ‚
        // å¦‚æœå½“å‰ç« èŠ‚æ­£åœ¨æ’­æ”¾ï¼Œä¸é‡æ–°è®¾ç½® src
        window.addEventListener('load', function() {
            // è®¾ç½®å…¨å±€å½“å‰ç« èŠ‚ID
            window.currentChapterId = chapterId;
            
            if (window.globalPlayer && window.globalPlayer.currentState.chapterId == chapterId) {
                console.log('å½“å‰ç« èŠ‚æ­£åœ¨æ’­æ”¾ï¼Œä¿æŒæ’­æ”¾çŠ¶æ€');
                // ä»…æ˜¾ç¤ºæ’­æ”¾å™¨ï¼Œä¸é‡æ–°åŠ è½½
                window.globalPlayer.show();
            }
            
            // åˆå§‹åŒ–å­—ä½“å¤§å°æ§åˆ¶
            initFontSizeControl();
            
            // åˆå§‹åŒ–ç‚¹å‡»åˆ‡æ¢æ‚¬æµ®æŒ‰é’®
            initToggleButtons();
            
            // åˆå§‹åŒ–ç« èŠ‚é¢æ¿
            initChapterPanel();
            
            // åˆå§‹åŒ–å¯¼èˆªæŒ‰é’®äº‹ä»¶
            initNavigationButtons();
        });
        
        // åˆå§‹åŒ–å¯¼èˆªæŒ‰é’®äº‹ä»¶
        function initNavigationButtons() {
            document.getElementById('prevChapterBtn').addEventListener('click', prevChapter);
            document.getElementById('nextChapterBtn').addEventListener('click', nextChapter);
            document.getElementById('tocBtn').addEventListener('click', openChapterPanel);
            document.getElementById('closeChapterPanel').addEventListener('click', closeChapterPanel);
            document.getElementById('chapterPanelOverlay').addEventListener('click', closeChapterPanel);
            document.getElementById('chapterSearch').addEventListener('input', function(e) {
                searchChapters(e.target.value);
            });
            
            // è¿”å›æŒ‰é’®
            document.getElementById('backBtn').addEventListener('click', function() {
                window.location.href = '/novels/list';
            });
            
            // å¤„ç†æµè§ˆå™¨å‰è¿›åé€€
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.chapterId) {
                    const newChapterIndex = chaptersData.findIndex(chapter => chapter.id == event.state.chapterId);
                    if (newChapterIndex !== -1) {
                        currentChapterIndex = newChapterIndex;
                        window.currentChapterId = event.state.chapterId;
                        loadChapterContent(event.state.chapterId);
                        updateNavigation();
                        updateChapterListActiveState(event.state.chapterId);
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–ç« èŠ‚é¢æ¿
        function initChapterPanel() {
            // åˆå§‹æ¸²æŸ“ç« èŠ‚åˆ—è¡¨
            renderChapterList();
        }
        
        // å­—ä½“å¤§å°æ§åˆ¶åŠŸèƒ½
        function initFontSizeControl() {
            const chapterContent = document.getElementById('chapterContent');
            const fontIncreaseBtn = document.getElementById('fontIncreaseBtn');
            const fontDecreaseBtn = document.getElementById('fontDecreaseBtn');
            
            // ä» localStorage è¯»å–ä¿å­˜çš„å­—ä½“å¤§å°
            let fontSize = parseInt(localStorage.getItem('readerFontSize')) || 17;
            chapterContent.style.fontSize = fontSize + 'px';
            
            // å¢å¤§å­—ä½“
            fontIncreaseBtn.addEventListener('click', function() {
                if (fontSize < 28) {
                    fontSize += 1;
                    chapterContent.style.fontSize = fontSize + 'px';
                    localStorage.setItem('readerFontSize', fontSize);
                }
            });
            
            // å‡å°å­—ä½“
            fontDecreaseBtn.addEventListener('click', function() {
                if (fontSize > 12) {
                    fontSize -= 1;
                    chapterContent.style.fontSize = fontSize + 'px';
                    localStorage.setItem('readerFontSize', fontSize);
                }
            });
        }
        
        // æ›´æ–°é˜…è¯»è¿›åº¦
        function updateReadingProgress(novelId, chapterId) {
            fetch(`/novels/${novelId}/reading-progress`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chapter_id: chapterId
                })
            }).catch(error => {
                console.error('Error updating reading progress:', error);
            });
        }
        
        // ç‚¹å‡»ç« èŠ‚å†…å®¹åˆ‡æ¢é¢æ¿æ˜¾ç¤º/éšè—
        function initToggleButtons() {
            const chapterContent = document.getElementById('chapterContent');
            const topPanel = document.getElementById('topPanel');
            const bottomPanel = document.getElementById('bottomPanel');
            let isPanelsVisible = false;
            
            // ç‚¹å‡»ç« èŠ‚å†…å®¹åˆ‡æ¢é¢æ¿æ˜¾ç¤ºçŠ¶æ€
            chapterContent.addEventListener('click', function(e) {
                // é˜²æ­¢ç‚¹å‡»é“¾æ¥ç­‰å…ƒç´ æ—¶è§¦å‘
                if (e.target.tagName === 'A' || e.target.closest('a')) {
                    return;
                }
                
                if (isPanelsVisible) {
                    // éšè—é¢æ¿
                    topPanel.classList.remove('visible');
                    bottomPanel.classList.remove('visible');
                    isPanelsVisible = false;
                } else {
                    // æ˜¾ç¤ºé¢æ¿
                    topPanel.classList.add('visible');
                    bottomPanel.classList.add('visible');
                    isPanelsVisible = true;
                }
            });
            
            // ç‚¹å‡»é¢æ¿ç©ºç™½åŒºåŸŸæ—¶ä¸éšè—ï¼ˆæŒ‰é’®ç‚¹å‡»ä¼šæ­£å¸¸è§¦å‘ï¼‰
            topPanel.addEventListener('click', function(e) {
                if (e.target === topPanel) {
                    e.stopPropagation();
                }
            });
            
            bottomPanel.addEventListener('click', function(e) {
                if (e.target === bottomPanel) {
                    e.stopPropagation();
                }
            });
        }
    </script>
{% endblock %}